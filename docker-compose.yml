version: '3'

services:
  web:
    build:
      context: .
      args:
        PHP_VERSION: "8.2"
        MAGENTO_VERSION: "2.4.7-p4"
    container_name: magento2-container
    environment:
      DB_SERVER: mariadb
      OPENSEARCH_SERVER: opensearch
      RABBITMQ_SERVER: rabbitmq
      VIRTUAL_HOST: ${APP_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      USE_SSL: 1
      DEPLOY_SAMPLEDATA: 1
    ports:
      - 8080:80
    depends_on:
      - db
      - opensearch
      - rabbitmq
    networks:
      backend:
  db:
    image: mariadb:10.4
    container_name: mariadb
    environment:
      MARIADB_ROOT_PASSWORD: root_password
      MARIADB_DATABASE: magento
      MARIADB_USER: magento
      MARIADB_PASSWORD: magento
    networks:
      - backend
  opensearch:
    image: bitnami/opensearch:2.11.1
    container_name: opensearch
    ports:
      - 9200:9200
      - 9300:9300
    environment:
      - "discovery.type=single-node"
      - ES_JAVA_OPTS=-Xms750m -Xmx750m
    networks:
      - backend
  rabbitmq:
    image: bitnami/rabbitmq:3.12.13-debian-11-r0
    container_name: rabbitmq
    networks:
      - backend
    ports:
      - 15672:15672
networks:
  backend:
